#cloud-config

write_files:
  - path: /run/user/pgbouncer.ini
    permissions: "0644"
    encoding: b64
    content: ${config}
  - path: /run/user/userlist.txt
    permissions: "0644"
    encoding: b64
    content: ${userlist}
  - path: /etc/docker/cloudsql-config.json
    content: |
      {
        "projects": ["${project_id}"],
        "instances": [{"instance": "${cloud_sql_instance_name}", "port": "${cloud_sql_proxy_port}"}]
      }
  - path: /docker-compose.yml
    permissions: "0644"
    owner: root
    content: |
      version: '3'
      services:
        cloudsql-proxy:
          image: ${cloud_sql_proxy_image}
          command: ${cloud_sql_instance_name}
          restart: always
          networks:
            - cloudsql-pgbouncer
          ports:
            - "${cloud_sql_proxy_port}:${cloud_sql_proxy_port}"
          volumes:
            - /etc/docker/cloudsql-config.json:/etc/cloudsql/config.json
          depends_on:
            - pgbouncer
        pgbouncer:
          image: ${image}
          restart: always
          networks:
            - cloudsql-pgbouncer
          ports:
            - "${listen_port}:${listen_port}"
          volumes:
            - /run/user/userlist.txt:/etc/pgbouncer/userlist.txt:ro
            - /run/user/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      networks:
        cloudsql-pgbouncer:

runcmd:
  - curl -SL https://github.com/docker/compose/releases/download/v2.17.2/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  - docker-compose up -d
